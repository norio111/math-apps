<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¾®åˆ†ãƒ‰ãƒªãƒ« v3</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI','Hiragino Sans',sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);color:#fff;padding:20px}
.card{background:rgba(255,255,255,.07);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.12);border-radius:24px;padding:40px 36px;width:520px;max-width:96vw;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.3)}
h1{font-size:18px;font-weight:500;letter-spacing:.15em;color:rgba(255,255,255,.5);margin-bottom:4px}
.version{font-size:12px;color:rgba(255,255,255,.25);margin-bottom:8px}
.score-bar{display:flex;justify-content:center;gap:20px;font-size:14px;color:rgba(255,255,255,.45);margin-bottom:8px}
.score-bar span{font-weight:600;color:rgba(255,255,255,.8)}
.progress-wrap{width:100%;height:6px;background:rgba(255,255,255,.08);border-radius:3px;margin-bottom:24px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#7f5af0,#2cb67d);border-radius:3px;transition:width .4s ease}
.level-bar{display:flex;justify-content:center;gap:8px;margin-bottom:28px}
.level-btn{font-size:13px;font-weight:600;padding:8px 16px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:rgba(255,255,255,.05);color:rgba(255,255,255,.5);cursor:pointer;transition:all .2s}
.level-btn:hover{background:rgba(255,255,255,.1)}
.level-btn.active{background:rgba(127,90,240,.25);border-color:rgba(127,90,240,.5);color:#c4b5fd}
.question{font-size:36px;font-weight:700;margin-bottom:8px;line-height:1.4}
.sub-label{font-size:14px;color:rgba(255,255,255,.4);margin-bottom:32px}
.q-number{font-size:13px;color:rgba(255,255,255,.3);margin-bottom:4px}
.input-row{display:flex;gap:10px;margin-bottom:16px}
input{flex:1;font-size:22px;padding:14px 16px;border:2px solid rgba(255,255,255,.15);border-radius:14px;background:rgba(255,255,255,.06);color:#fff;text-align:center;outline:none;transition:border-color .2s}
input::placeholder{color:rgba(255,255,255,.25)}
input:focus{border-color:rgba(160,140,255,.6)}
button{font-size:16px;font-weight:600;padding:14px 28px;border:none;border-radius:14px;cursor:pointer;transition:transform .1s,box-shadow .2s}
button:active{transform:scale(.97)}
.btn-check{background:linear-gradient(135deg,#7f5af0,#6246ea);color:#fff;box-shadow:0 4px 18px rgba(127,90,240,.35)}
.btn-check:hover{box-shadow:0 6px 24px rgba(127,90,240,.5)}
.btn-next{width:100%;padding:14px;background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.12);border-radius:14px;display:none}
.btn-next:hover{background:rgba(255,255,255,.12)}
.result{min-height:56px;display:flex;align-items:center;justify-content:center;margin:20px 0 8px;font-size:20px;font-weight:600;border-radius:14px;padding:12px}
.result.ok{background:rgba(72,199,142,.15);color:#48c78e}
.result.ng{background:rgba(255,99,99,.12);color:#ff6b6b}
.explain{margin-top:8px;padding:12px;border-radius:10px;background:rgba(255,200,50,.08);font-size:14px;color:rgba(255,255,255,.6);line-height:1.7;text-align:left;display:none}
.explain b{color:rgba(255,200,100,.9)}
.hint{font-size:13px;color:rgba(255,255,255,.3);margin-top:4px}
.rule-box{margin-top:16px;padding:12px;border-radius:10px;background:rgba(255,255,255,.04);font-size:13px;color:rgba(255,255,255,.35);line-height:1.8;text-align:left}
.rule-box b{color:rgba(255,255,255,.55)}
.review-screen{display:none}
.review-screen h2{font-size:22px;font-weight:700;margin-bottom:6px}
.review-summary{font-size:16px;color:rgba(255,255,255,.6);margin-bottom:20px}
.review-summary .big{font-size:40px;font-weight:700}
.review-summary .perfect{color:#48c78e}
.review-summary .good{color:#7f5af0}
.review-summary .retry{color:#ff6b6b}
.review-table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:14px}
.review-table th{padding:8px 4px;text-align:left;font-weight:600;color:rgba(255,255,255,.4);border-bottom:1px solid rgba(255,255,255,.1);font-size:12px}
.review-table td{padding:8px 4px;border-bottom:1px solid rgba(255,255,255,.05);color:rgba(255,255,255,.7)}
.mark-ok{color:#48c78e}.mark-ng{color:#ff6b6b}
.your-ans{color:rgba(255,255,255,.5)}
.correct-ans{color:#c4b5fd}
.review-explain{text-align:left;margin-bottom:20px}
.review-explain-item{padding:12px;border-radius:10px;margin-bottom:8px;background:rgba(255,99,99,.06);border-left:3px solid rgba(255,99,99,.3)}
.review-explain-item .q-title{font-weight:700;font-size:15px;margin-bottom:6px;color:rgba(255,255,255,.8)}
.review-explain-item .steps{font-size:13px;color:rgba(255,255,255,.5);line-height:1.8}
.review-explain-item .steps b{color:rgba(255,200,100,.9)}
.miss-stats{margin-bottom:16px;padding:12px;border-radius:10px;background:rgba(127,90,240,.08);font-size:14px;color:rgba(255,255,255,.5);text-align:left;display:none}
.miss-stats b{color:rgba(200,180,255,.9)}
.btn-continue{width:100%;padding:16px;background:linear-gradient(135deg,#7f5af0,#6246ea);color:#fff;border-radius:14px;font-size:16px;font-weight:600;border:none;cursor:pointer;box-shadow:0 4px 18px rgba(127,90,240,.35)}
@keyframes pop{0%{transform:scale(.9);opacity:0}100%{transform:scale(1);opacity:1}}
.pop{animation:pop .25s ease-out}
@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .4s ease-out}
</style>
</head>
<body>
<div class="card">

<div class="quiz-screen" id="quiz-screen">
<h1>å¾®åˆ†ãƒ‰ãƒªãƒ«</h1>
<div class="version">v3 - 10å•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»è§£èª¬ãƒ»ãƒŸã‚¹å‚¾å‘åˆ†æ</div>
<div class="score-bar">
<div>æ­£è§£ <span id="ok-count">0</span></div>
<div>ä¸æ­£è§£ <span id="ng-count">0</span></div>
<div>é€£ç¶š <span id="streak">0</span>&#x1F525;</div>
</div>
<div class="progress-wrap"><div class="progress-fill" id="progress" style="width:0%"></div></div>
<div class="level-bar">
<div class="level-btn active" onclick="setLevel(1)">åŸºæœ¬</div>
<div class="level-btn" onclick="setLevel(2)">æ¨™æº–</div>
<div class="level-btn" onclick="setLevel(3)">ç™ºå±•</div>
</div>
<div class="q-number" id="q-number">Q1 / 10</div>
<div class="question" id="q"></div>
<div class="sub-label">ã‚’å¾®åˆ†ã›ã‚ˆ</div>
<div class="input-row">
<input id="ans" placeholder="ä¾‹: 6x^2" autocomplete="off">
<button class="btn-check" onclick="doCheck()">åˆ¤å®š</button>
</div>
<div class="hint" id="hint">x^2 ã¨å…¥åŠ›ã€‚å®šæ•°ã®å¾®åˆ†ã¯ 0</div>
<div class="result" id="result"></div>
<div class="explain" id="explain"></div>
<button class="btn-next" id="btn-next" onclick="doNext()">æ¬¡ã®å•é¡Œ</button>
<div class="rule-box" id="rule-box">
<b>åŸºæœ¬ãƒ«ãƒ¼ãƒ«:</b> ax<sup>n</sup> â†’ anx<sup>n-1</sup><br>
<b>å®šæ•°:</b> 5 â†’ 0<br>
<b>1ä¹—:</b> 3x â†’ 3
</div>
</div>

<div class="review-screen" id="review-screen">
<h2>10å•ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
<div class="review-summary" id="review-summary"></div>
<div class="miss-stats" id="miss-stats"></div>
<table class="review-table">
<thead><tr><th>#</th><th>å•é¡Œ</th><th>ã‚ãªãŸ</th><th>æ­£è§£</th><th></th></tr></thead>
<tbody id="review-body"></tbody>
</table>
<div class="review-explain" id="review-explain"></div>
<button class="btn-continue" onclick="startNewRound()">æ¬¡ã®10å•ã¸</button>
</div>

</div>
<script>
var currentA=0,currentN=0,level=1;
var okCount=0,ngCount=0,streak=0;
var roundNum=0,quizlog=[],ROUND_SIZE=10,answered=false;

// ä¸Šä»˜ãæ–‡å­—å¤‰æ›
function toSup(num){
  var m={};
  m["-"]="\u207B";m["0"]="\u2070";m["1"]="\u00B9";m["2"]="\u00B2";
  m["3"]="\u00B3";m["4"]="\u2074";m["5"]="\u2075";m["6"]="\u2076";
  m["7"]="\u2077";m["8"]="\u2078";m["9"]="\u2079";
  var s=String(num),r="";
  for(var i=0;i<s.length;i++){r+=(m[s[i]]||s[i]);}
  return r;
}

// ç¶ºéº—ãªè¡¨ç¤º
function pretty(c,e){
  if(e===0)return String(c);
  var b;
  if(c===1)b="x";else if(c===-1)b="-x";else b=c+"x";
  if(e===1)return b;
  return b+toSup(e);
}

// ãƒ¬ãƒ™ãƒ«è¨­å®š
function setLevel(lv){
  level=lv;
  var btns=document.querySelectorAll(".level-btn");
  for(var i=0;i<btns.length;i++){btns[i].className="level-btn"+(i+1===lv?" active":"");}
  var rb=document.getElementById("rule-box");
  var ht=document.getElementById("hint");
  if(lv===1){
    rb.innerHTML="<b>åŸºæœ¬ãƒ«ãƒ¼ãƒ«:</b> ax<sup>n</sup> â†’ anx<sup>n-1</sup><br><b>å®šæ•°:</b> 5 â†’ 0<br><b>1ä¹—:</b> 3x â†’ 3";
    ht.textContent="x^2 ã¨å…¥åŠ›ã€‚å®šæ•°ã®å¾®åˆ†ã¯ 0";
  }else if(lv===2){
    rb.innerHTML="<b>åŸºæœ¬ãƒ«ãƒ¼ãƒ«:</b> ax<sup>n</sup> â†’ anx<sup>n-1</sup><br><b>å®šæ•°:</b> 5 â†’ 0<br><b>è² ã®æŒ‡æ•°:</b> 3x"+toSup(-2)+" â†’ -6x"+toSup(-3);
    ht.textContent="è² ã®æŒ‡æ•°ã¯ x^-2 ã¨å…¥åŠ›";
  }else{
    rb.innerHTML="<b>å…¨ç¯„å›²:</b> å®šæ•°ãƒ»æ­£è² ã®æŒ‡æ•°ãƒ»è² ã®ä¿‚æ•°ã‚‚å‡ºé¡Œ<br><b>åˆ†æ•°å½¢å¼ã‚‚OK:</b> 3/x^2 = 3x"+toSup(-2);
    ht.textContent="åˆ†æ•°å½¢å¼ (3/x^2) ã§ã®å›ç­”ã‚‚å¯";
  }
  startNewRound();
}

// å•é¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
function genParams(){
  if(level===1){currentA=Math.floor(Math.random()*9)+1;currentN=Math.floor(Math.random()*6);}
  else if(level===2){currentA=Math.floor(Math.random()*9)+1;currentN=Math.floor(Math.random()*8)-2;}
  else{
    currentA=Math.floor(Math.random()*12)+1;
    if(Math.random()<0.3)currentA=-currentA;
    currentN=Math.floor(Math.random()*9)-3;
    if(currentN===0&&Math.random()<0.5)currentN=Math.floor(Math.random()*5)+1;
  }
}

// å•é¡Œè¡¨ç¤º
function showQuestion(){
  genParams();answered=false;
  document.getElementById("q-number").textContent="Q"+(roundNum+1)+" / "+ROUND_SIZE;
  document.getElementById("q").textContent=pretty(currentA,currentN);
  document.getElementById("ans").value="";
  document.getElementById("result").className="result";
  document.getElementById("result").textContent="";
  document.getElementById("explain").style.display="none";
  document.getElementById("btn-next").style.display="none";
  document.getElementById("progress").style.width=(roundNum/ROUND_SIZE*100)+"%";
  document.getElementById("ans").focus();
}

// å…¥åŠ›æ­£è¦åŒ–
function norm(s){
  var r=s.replace(/\s/g,"");
  r=r.replace(/\*\*/g,"^");
  r=r.replace(/\u00d7/g,"*");
  r=r.replace(/[\uff38\uff58]/g,"x");
  r=r.replace(/\u2212/g,"-");
  r=r.replace(/\u207B/g,"-");
  r=r.replace(/\u2070/g,"^0");
  r=r.replace(/\u00B9/g,"^1");
  r=r.replace(/\u00B2/g,"^2");
  r=r.replace(/\u00B3/g,"^3");
  r=r.replace(/\u2074/g,"^4");
  r=r.replace(/\u2075/g,"^5");
  r=r.replace(/\u2076/g,"^6");
  r=r.replace(/\u2077/g,"^7");
  r=r.replace(/\u2078/g,"^8");
  r=r.replace(/\u2079/g,"^9");
  r=r.toLowerCase();
  return r;
}

// æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³
function okAnswers(c,e){
  var L=[];
  if(c===0){L.push("0");return L.map(norm);}
  if(e===0){L.push(String(c));}
  else if(e===1){
    if(c===1){L.push("x");L.push("1x");L.push("1*x");}
    else if(c===-1){L.push("-x");L.push("-1x");L.push("-1*x");}
    else{L.push(c+"x");L.push(c+"*x");}
  }else{
    if(c===1){L.push("x^"+e);L.push("x^("+e+")");L.push("1x^"+e);L.push("1*x^"+e);}
    else if(c===-1){L.push("-x^"+e);L.push("-x^("+e+")");L.push("-1x^"+e);L.push("-1*x^"+e);}
    else{L.push(c+"x^"+e);L.push(c+"x^("+e+")");L.push(c+"*x^"+e);L.push(c+"*x^("+e+")");}
  }
  if(e<0){
    var ep=Math.abs(e),ac=Math.abs(c),sign=(c<0)?"-":"";
    if(ep===1){
      L.push(sign+ac+"/x");L.push(sign+ac+"/(x)");
      if(ac===1){L.push(sign+"1/x");L.push(sign+"1/(x)");}
    }else{
      L.push(sign+ac+"/x^"+ep);L.push(sign+ac+"/(x^"+ep+")");
      if(ac===1){L.push(sign+"1/x^"+ep);L.push(sign+"1/(x^"+ep+")");}
    }
  }
  return L.map(norm);
}

// è§£èª¬
function makeExplain(qa,qn){
  if(qn===0){return"<b>å®šæ•°ã®å¾®åˆ†ã¯ 0</b><br>"+pretty(qa,0)+" ã¯xã‚’å«ã¾ãªã„å®šæ•°<br>â†’ å¾®åˆ†ã™ã‚‹ã¨ <b>0</b>";}
  var cc=qa*qn,ce=qn-1;
  var s="<b>å…¬å¼:</b> ax<sup>n</sup> â†’ aÃ—n Ã— x<sup>n-1</sup><br>";
  s+="<b>(1)</b> a="+qa+", n="+qn+"<br>";
  s+="<b>(2)</b> ä¿‚æ•°: "+qa+" Ã— "+(qn<0?"("+qn+")":qn)+" = "+cc+"<br>";
  s+="<b>(3)</b> æŒ‡æ•°: "+qn+" - 1 = "+ce+"<br>";
  s+="<b>(4)</b> ç­”ãˆ: <b>"+(cc===0?"0":pretty(cc,ce))+"</b>";
  return s;
}

// åˆ¤å®š
function doCheck(){
  if(answered)return;
  answered=true;
  var cC,cE;
  if(currentN===0){cC=0;cE=0;}else{cC=currentA*currentN;cE=currentN-1;}
  var userRaw=document.getElementById("ans").value;
  var user=norm(userRaw);
  var acc=okAnswers(cC,cE);
  var isOk=false;
  for(var i=0;i<acc.length;i++){if(acc[i]===user){isOk=true;break;}}
  var correctDisplay=(currentN===0)?"0":pretty(cC,cE);
  quizlog.push({qA:currentA,qN:currentN,qDisplay:pretty(currentA,currentN),userAns:userRaw||"(æœªå…¥åŠ›)",correctAns:correctDisplay,ok:isOk});
  var el=document.getElementById("result");
  el.classList.add("pop");
  setTimeout(function(){el.classList.remove("pop");},300);
  if(isOk){
    okCount++;streak++;el.className="result ok";
    if(streak>=5)el.textContent="â­• å®Œç’§ï¼ "+streak+"é€£ç¶šğŸ”¥ğŸ”¥";
    else if(streak>=3)el.textContent="â­• æ­£è§£ï¼ "+streak+"é€£ç¶šğŸ”¥";
    else el.textContent="â­• æ­£è§£ï¼";
  }else{
    ngCount++;streak=0;el.className="result ng";
    el.textContent="âŒ ä¸æ­£è§£ â†’ ç­”ãˆ: "+correctDisplay;
    var expEl=document.getElementById("explain");
    expEl.innerHTML=makeExplain(currentA,currentN);
    expEl.style.display="block";
  }
  document.getElementById("ok-count").textContent=okCount;
  document.getElementById("ng-count").textContent=ngCount;
  document.getElementById("streak").textContent=streak;
  document.getElementById("progress").style.width=((roundNum+1)/ROUND_SIZE*100)+"%";
  roundNum++;
  var bn=document.getElementById("btn-next");
  bn.textContent=(roundNum>=ROUND_SIZE)?"çµæœã‚’è¦‹ã‚‹ ğŸ“Š":"æ¬¡ã®å•é¡Œ â†’";
  bn.style.display="block";
  try{localStorage.setItem("bibun_ok",okCount);localStorage.setItem("bibun_ng",ngCount);localStorage.setItem("bibun_streak",streak);}catch(e){}
}

function doNext(){
  if(roundNum>=ROUND_SIZE)showReview();else showQuestion();
}

// ãƒŸã‚¹å‚¾å‘
function analyzeMisses(){
  var cm=0,nm=0,sm=0;
  for(var i=0;i<quizlog.length;i++){
    var h=quizlog[i];
    if(!h.ok){
      if(h.qN===0)cm++;
      else if(h.qN<0)nm++;
      var u=norm(h.userAns).replace(/-/g,"");
      var c=norm(h.correctAns).replace(/-/g,"");
      if(u===c&&norm(h.userAns)!==norm(h.correctAns))sm++;
    }
  }
  return{constMiss:cm,negExpMiss:nm,signMiss:sm};
}

// ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢
function showReview(){
  document.getElementById("quiz-screen").style.display="none";
  var rev=document.getElementById("review-screen");
  rev.style.display="block";rev.classList.add("fade-in");
  var correct=0;
  for(var i=0;i<quizlog.length;i++){if(quizlog[i].ok)correct++;}
  var rate=Math.round(correct/ROUND_SIZE*100);
  var cls=(rate===100)?"perfect":(rate>=70)?"good":"retry";
  var msg=(rate===100)?"ğŸ‰ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼":(rate>=70)?"ğŸ‘ ã„ã„èª¿å­ï¼":"ğŸ’ª ã‚‚ã†ä¸€å›ï¼";
  document.getElementById("review-summary").innerHTML='<div class="big '+cls+'">'+correct+" / "+ROUND_SIZE+"</div><div>æ­£ç­”ç‡ "+rate+"% "+msg+"</div>";

  var stats=analyzeMisses();
  var sEl=document.getElementById("miss-stats");
  var wrongTotal=ROUND_SIZE-correct;
  if(wrongTotal>0){
    var html="<b>ğŸ” ãƒŸã‚¹å‚¾å‘:</b><br>";
    if(stats.constMiss>0)html+="ãƒ»å®šæ•°ãƒŸã‚¹: "+stats.constMiss+"å›<br>";
    if(stats.negExpMiss>0)html+="ãƒ»è² ã®æŒ‡æ•°ãƒŸã‚¹: "+stats.negExpMiss+"å›<br>";
    if(stats.signMiss>0)html+="ãƒ»ç¬¦å·ãƒŸã‚¹: "+stats.signMiss+"å›<br>";
    sEl.innerHTML=html;sEl.style.display="block";
  }else{sEl.style.display="none";}

  var tbody=document.getElementById("review-body");tbody.innerHTML="";
  for(var j=0;j<quizlog.length;j++){
    var h=quizlog[j],tr=document.createElement("tr");
    tr.innerHTML="<td>"+(j+1)+"</td><td>"+h.qDisplay+"</td>"+'<td class="your-ans">'+h.userAns+"</td>"+'<td class="correct-ans">'+h.correctAns+"</td>"+'<td class="'+(h.ok?"mark-ok":"mark-ng")+'">'+(h.ok?"â­•":"âŒ")+"</td>";
    tbody.appendChild(tr);
  }

  var ew=document.getElementById("review-explain");ew.innerHTML="";
  var hasW=false;
  for(var k=0;k<quizlog.length;k++){
    if(!quizlog[k].ok){
      if(!hasW){
        var t=document.createElement("div");
        t.style.cssText="font-weight:700;font-size:15px;color:rgba(255,255,255,.6);margin-bottom:12px;";
        t.textContent="ğŸ“ é–“é•ã£ãŸå•é¡Œã®è§£èª¬";
        ew.appendChild(t);hasW=true;
      }
      var w=quizlog[k],d=document.createElement("div");
      d.className="review-explain-item";
      d.innerHTML='<div class="q-title">'+w.qDisplay+" ã‚’å¾®åˆ†</div>"+'<div class="steps">'+makeExplain(w.qA,w.qN)+"</div>";
      ew.appendChild(d);
    }
  }
}

function startNewRound(){
  roundNum=0;quizlog=[];
  document.getElementById("review-screen").style.display="none";
  document.getElementById("review-screen").classList.remove("fade-in");
  document.getElementById("quiz-screen").style.display="block";
  showQuestion();
}

document.getElementById("ans").addEventListener("keydown",function(e){
  if(e.key==="Enter"){
    if(document.getElementById("btn-next").style.display==="block")doNext();
    else doCheck();
  }
});

try{
  var sv=localStorage.getItem("bibun_ok");
  if(sv!==null){
    okCount=Number(sv)||0;ngCount=Number(localStorage.getItem("bibun_ng"))||0;
    streak=Number(localStorage.getItem("bibun_streak"))||0;
    document.getElementById("ok-count").textContent=okCount;
    document.getElementById("ng-count").textContent=ngCount;
    document.getElementById("streak").textContent=streak;
  }
}catch(e){okCount=0;ngCount=0;streak=0;}

showQuestion();
</script>
</body>
</html>